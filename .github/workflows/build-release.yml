name: Build Release Binaries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-boost
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-libevent
            mingw-w64-x86_64-db
            mingw-w64-x86_64-qt5-base
            mingw-w64-x86_64-qt5-tools
            mingw-w64-x86_64-qrencode
            mingw-w64-x86_64-protobuf
            autoconf
            automake
            libtool
            pkg-config

      - name: Build Badcoin
        shell: msys2 {0}
        run: |
          export PATH="/mingw64/bin:$PATH"
          export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig:/mingw64/share/pkgconfig:$PKG_CONFIG_PATH"

          # Debug: Check if Qt5 pkg-config files exist
          echo "Checking Qt5 pkg-config..."
          pkg-config --modversion Qt5Core || echo "Qt5Core not found via pkg-config"
          ls -la /mingw64/lib/pkgconfig/Qt5* 2>/dev/null || echo "No Qt5 .pc files in lib/pkgconfig"

          ./autogen.sh
          ./configure \
            --with-gui=qt5 \
            --disable-tests \
            --disable-bench \
            --with-incompatible-bdb \
            --with-boost=/mingw64 \
            --with-qt-incdir=/mingw64/include/qt5 \
            --with-qt-libdir=/mingw64/lib \
            --with-qt-bindir=/mingw64/bin \
            --with-qt-plugindir=/mingw64/share/qt5/plugins \
            BOOST_LDFLAGS="-L/mingw64/lib" \
            CPPFLAGS="-DBOOST_BIND_GLOBAL_PLACEHOLDERS -I/mingw64/include -I/mingw64/include/qt5 -I/mingw64/include/qt5/QtCore -I/mingw64/include/qt5/QtGui -I/mingw64/include/qt5/QtWidgets -I/mingw64/include/qt5/QtNetwork" \
            CXXFLAGS="-O2" \
            LDFLAGS="-L/mingw64/lib" \
            --prefix=/mingw64
          make -j4

      - name: Package binaries
        shell: msys2 {0}
        run: |
          mkdir -p release
          cp src/badcoind.exe release/
          cp src/badcoin-cli.exe release/
          cp src/badcoin-tx.exe release/
          cp src/qt/badcoin-qt.exe release/

          # Copy required DLLs from all executables
          for exe in release/*.exe; do
            if [ -f "$exe" ]; then
              ldd "$exe" | grep mingw | awk '{print $3}' | xargs -I {} cp -n {} release/ 2>/dev/null || true
            fi
          done

          # Explicitly copy Berkeley DB DLLs if they exist
          cp /mingw64/bin/libdb-*.dll release/ 2>/dev/null || true
          cp /mingw64/bin/libdb_cxx-*.dll release/ 2>/dev/null || true

          # Copy Qt5 plugins needed for GUI
          mkdir -p release/platforms
          cp /mingw64/share/qt5/plugins/platforms/qwindows.dll release/platforms/ 2>/dev/null || true

      - name: Create README for Windows users
        run: |
          echo "# Badcoin for Windows" > release/README.txt
          echo "" >> release/README.txt
          echo "## Quick Start (GUI)" >> release/README.txt
          echo "" >> release/README.txt
          echo "Double-click badcoin-qt.exe to launch the graphical wallet." >> release/README.txt
          echo "" >> release/README.txt
          echo "## Quick Start (Command Line)" >> release/README.txt
          echo "" >> release/README.txt
          echo "1. Open Command Prompt in this directory" >> release/README.txt
          echo "" >> release/README.txt
          echo "2. Start the Badcoin daemon (will run in foreground):" >> release/README.txt
          echo "   badcoind.exe -maxtipage=120000000 -algo=yescrypt -noonion -printtoconsole" >> release/README.txt
          echo "" >> release/README.txt
          echo "   NOTE: Keep this window open! On Windows, badcoind runs in the foreground." >> release/README.txt
          echo "   The -daemon flag does NOT work on Windows." >> release/README.txt
          echo "" >> release/README.txt
          echo "3. Open a SECOND Command Prompt to interact with the node:" >> release/README.txt
          echo "   badcoin-cli.exe getblockchaininfo" >> release/README.txt
          echo "" >> release/README.txt
          echo "4. Get your wallet address:" >> release/README.txt
          echo "   badcoin-cli.exe getnewaddress" >> release/README.txt
          echo "" >> release/README.txt
          echo "5. Mine blocks (replace YOUR_ADDRESS with address from step 4):" >> release/README.txt
          echo "   badcoin-cli.exe -rpcclienttimeout=1800 generatetoaddress 10 \"YOUR_ADDRESS\"" >> release/README.txt
          echo "" >> release/README.txt
          echo "   NOTE: Mining takes 2-10 minutes per block. RPC timeout is normal." >> release/README.txt
          echo "   The daemon keeps mining even if the CLI times out." >> release/README.txt
          echo "" >> release/README.txt
          echo "## CRITICAL FLAGS (Always Required)" >> release/README.txt
          echo "" >> release/README.txt
          echo "-maxtipage=120000000  # Accept old blockchain data" >> release/README.txt
          echo "-algo=yescrypt        # Easiest mining algorithm for CPU" >> release/README.txt
          echo "-noonion              # REQUIRED: Prevents random shutdowns on Windows" >> release/README.txt
          echo "" >> release/README.txt
          echo "## Alternative: Run in Background" >> release/README.txt
          echo "" >> release/README.txt
          echo "To run in background (no console output):" >> release/README.txt
          echo "   start /B badcoind.exe -maxtipage=120000000 -algo=yescrypt -noonion" >> release/README.txt
          echo "" >> release/README.txt
          echo "Check debug.log in %APPDATA%\\Badcoin\\ for output." >> release/README.txt
          echo "" >> release/README.txt
          echo "## Support" >> release/README.txt
          echo "" >> release/README.txt
          echo "GitHub: https://github.com/kbadinger/badcoin" >> release/README.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: badcoin-windows
          path: release/

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          brew install boost libevent berkeley-db@4 openssl autoconf automake libtool qt@5 qrencode protobuf@21

      - name: Build Badcoin
        run: |
          ./autogen.sh

          export PKG_CONFIG_PATH="/opt/homebrew/opt/libevent/lib/pkgconfig:/opt/homebrew/opt/qt@5/lib/pkgconfig:/opt/homebrew/opt/protobuf@21/lib/pkgconfig:$PKG_CONFIG_PATH"
          export PATH="/opt/homebrew/opt/qt@5/bin:/opt/homebrew/opt/protobuf@21/bin:$PATH"

          ./configure \
            --with-gui=qt5 \
            --with-boost=/opt/homebrew/opt/boost \
            --disable-tests \
            --disable-bench \
            CPPFLAGS="-DBOOST_BIND_GLOBAL_PLACEHOLDERS -I/opt/homebrew/opt/protobuf@21/include -I/opt/homebrew/opt/openssl@3/include" \
            LDFLAGS="-L/opt/homebrew/opt/protobuf@21/lib -L/opt/homebrew/opt/openssl@3/lib"

          make -j$(sysctl -n hw.ncpu)

      - name: Package binaries
        run: |
          mkdir -p release
          cp src/badcoind release/ || true
          cp src/badcoin-cli release/ || true
          cp src/badcoin-tx release/ || true
          cp src/qt/badcoin-qt release/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: badcoin-macos
          path: release/

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libtool autotools-dev automake autoconf \
            pkg-config libssl-dev libevent-dev bsdmainutils \
            libboost-system-dev libboost-filesystem-dev \
            libboost-program-options-dev libboost-thread-dev \
            libboost-chrono-dev libdb5.3-dev libdb5.3++-dev \
            libqt5gui5 libqt5core5a libqt5dbus5 qttools5-dev qttools5-dev-tools \
            libqrencode-dev libprotobuf-dev protobuf-compiler

      - name: Build Badcoin
        run: |
          ./autogen.sh
          ./configure \
            --with-gui=qt5 \
            --disable-tests \
            --disable-bench \
            --with-incompatible-bdb \
            CPPFLAGS="-DBOOST_BIND_GLOBAL_PLACEHOLDERS"
          make -j$(nproc)

      - name: Package binaries
        run: |
          mkdir -p release
          cp src/badcoind release/
          cp src/badcoin-cli release/
          cp src/badcoin-tx release/
          cp src/qt/badcoin-qt release/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: badcoin-linux
          path: release/

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create release archives
        run: |
          cd badcoin-windows && zip -r ../badcoin-windows.zip . && cd ..
          cd badcoin-macos && zip -r ../badcoin-macos.zip . && cd ..
          cd badcoin-linux && tar czf ../badcoin-linux.tar.gz . && cd ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            badcoin-windows.zip
            badcoin-macos.zip
            badcoin-linux.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
